C51 COMPILER V9.01   SERIAL                                                                03/07/2019 18:07:34 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE SERIAL
OBJECT MODULE PLACED IN serial.OBJ
COMPILER INVOKED BY: E:\Keil\C51\BIN\C51.EXE serial.c COMPACT ROM(COMPACT) OPTIMIZE(9,SIZE) BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "serial.h"
   2          #include <reg52.h>
   3          #include <intrins.h>
   4          // #include <stdio.h>
   5          // #include <string.h>
   6          // #include <stdarg.h>
   7          // #include "vsscanf.h"
   8          
   9          #define BUF_SIZE 128
  10          unsigned char buffer[BUF_SIZE];
  11          
  12          unsigned char rxIdx;
  13          unsigned char byteToRX;
  14          char rxDone;
  15          
  16          unsigned char txIdx;
  17          unsigned char byteToTX;
  18          char txDone;
  19          
  20          int receiveTotalTimeoutConstant = 1000;
  21          int receiveTotalTimeoutMultiplier = 50;
  22          int sendTotalTimeoutConstant = 1000;
  23          int sendTotalTimeoutMultiplier = 50;
  24          
  25          #define OSC_FREQ        12000000UL
  26          
  27          void setTimer0(unsigned int timeout)
  28          {
  29   1              TR0 = 0;                // stop timer 0
  30   1              TMOD &= 0xF0;
  31   1              TMOD |= 0x01; // timer 0, mode 1
  32   1              
  33   1              TH0 = (65536-timeout *(OSC_FREQ/12000000)) >> 8;
  34   1              TL0 = (65536-timeout *(OSC_FREQ/12000000)) & 0x00FF;
  35   1      
  36   1              TF0 = 0;                // clr overflow 
  37   1              TR0 = 1;
  38   1      }
  39          
  40          void serialSetReceiveTimeOut(unsigned int size)
  41          {
  42   1              setTimer0(size * receiveTotalTimeoutMultiplier + receiveTotalTimeoutConstant);
  43   1      }
  44          
  45          void serialSetSendTimeOut(unsigned int size)
  46          {
  47   1              setTimer0(size * sendTotalTimeoutMultiplier + sendTotalTimeoutConstant);
  48   1      }
  49          
  50          char serialIsTimeOut()
  51          {
  52   1              return TF0;
  53   1      }
  54          
  55          void serialISR(void) interrupt 4  
C51 COMPILER V9.01   SERIAL                                                                03/07/2019 18:07:34 PAGE 2   

  56          {
  57   1              if(RI)
  58   1              {
  59   2                      if(!rxDone)
  60   2                      {
  61   3                              buffer[rxIdx++] = SBUF;
  62   3                              if(rxIdx>=byteToRX)
  63   3                              {
  64   4                                      rxDone = -1;
  65   4                              }
  66   3                      }
  67   2                      
  68   2                      RI = 0;
  69   2              }
  70   1              if(TI)
  71   1              {
  72   2                      if(!txDone)
  73   2                      {
  74   3                              SBUF = buffer[txIdx++];
  75   3                              if(txIdx>=byteToTX)
  76   3                              {
  77   4                                      txDone = -1;
  78   4                              }
  79   3                      }
  80   2                      
  81   2                      TI = 0;
  82   2              }
  83   1      }
  84          
  85          void serialInitSendBuffer()
  86          {
  87   1              unsigned int i = 0;
  88   1              
  89   1              while(TI);
  90   1      
  91   1              while(i<BUF_SIZE)
  92   1              {
  93   2                      buffer[i] = 0;
  94   2                      i++;
  95   2              }
  96   1              txIdx = 0;
  97   1              byteToTX = 0;
  98   1              txDone = -1;
  99   1      }
 100          
 101          void serialSendDataAsync(unsigned char* dat, unsigned int size)
 102          {
 103   1              unsigned int i = 0;
 104   1              
 105   1              while(!txDone || TI);
 106   1              
 107   1              if(size>=BUF_SIZE)
 108   1                      size=BUF_SIZE;
 109   1              while(i<size)
 110   1              {
 111   2                      buffer[i] = dat[i];
 112   2                      i++;
 113   2              }
 114   1              txIdx = 0;
 115   1              byteToTX = size;
 116   1              txDone = 0;
 117   1      
C51 COMPILER V9.01   SERIAL                                                                03/07/2019 18:07:34 PAGE 3   

 118   1              TI = 1;
 119   1              serialSetSendTimeOut(size);
 120   1      }
 121          
 122          char serialIsSendDataDone()
 123          {
 124   1              while(TI);
 125   1      
 126   1              return txDone;
 127   1      }
 128          
 129          void serialSendData(unsigned char* dat, unsigned int size)
 130          {
 131   1              int time = 0;
 132   1              
 133   1              serialSendDataAsync(dat, size);
 134   1      
 135   1              while(!serialIsSendDataDone() /*&& !serialIsTimeOut()*/);
 136   1      }
 137           
 138          void serialInitReceiveBuffer()
 139          {
 140   1              unsigned int i = 0;
 141   1              
 142   1              while(RI);
 143   1              
 144   1              while(i<BUF_SIZE)
 145   1              {
 146   2                      buffer[i++] = 0;
 147   2              }
 148   1              rxIdx = 0;
 149   1              byteToRX = 0;
 150   1              rxDone = -1;
 151   1      }
 152          
 153          void serialReceiveDataAsync(unsigned int size)
 154          {
 155   1              unsigned int i = 0;
 156   1              
 157   1              while(!rxDone || RI);
 158   1      
 159   1              if(size>=BUF_SIZE)
 160   1                      size=BUF_SIZE;  
 161   1              while(i<BUF_SIZE)
 162   1              {
 163   2                      buffer[i++] = 0;
 164   2              }       
 165   1              rxIdx = 0;
 166   1              byteToRX = size;
 167   1      
 168   1              rxDone = 0;
 169   1              
 170   1              serialSetReceiveTimeOut(size);  
 171   1      }
 172          
 173          char serialIsReceiveDataDone()
 174          {
 175   1              while(RI);
 176   1      
 177   1              return rxDone;
 178   1      }
 179          
C51 COMPILER V9.01   SERIAL                                                                03/07/2019 18:07:34 PAGE 4   

 180          char* serialReceiveData(unsigned int size)
 181          {
 182   1              int time = 0;
 183   1              
 184   1              serialReceiveDataAsync(size);
 185   1      
 186   1              while(!serialIsReceiveDataDone()/*&& !serialIsTimeOut()*/);
 187   1              
 188   1              return buffer;
 189   1      }
 190          
 191          /*
 192          int serialPrintf(char* buffer, const char *fmt, ...)
 193          {
 194                  //char buffer[16];
 195          
 196                  va_list argptr;
 197                  int cnt;
 198                  va_start(argptr, fmt);
 199          
 200                  cnt = vsprintf(buffer, fmt, argptr);
 201          
 202                  va_end(argptr);
 203                  
 204                  serialSendData(buffer, strlen(buffer));
 205          
 206                  return cnt;
 207          }
 208          
 209          int serialScanf(char* buffer, const char *fmt, ...)
 210          {
 211                  va_list argptr;
 212                  int cnt;
 213          
 214                  //char buffer[16];
 215                  serialReceiveData(strlen(buffer));
 216          
 217                  va_start(argptr, fmt);
 218          
 219                  cnt = vsscanf(buffer, fmt, argptr);
 220          
 221                  va_end(argptr); 
 222          
 223                  return cnt;
 224          }
 225          */
 226          
 227          int serialInitialize(int baud)
 228          {       
 229   1              serialInitSendBuffer();
 230   1              serialInitReceiveBuffer();
 231   1                      
 232   1              ///////////////////////////////
 233   1              SCON=0X50;                      //ÉèÖÃÎª¹¤×÷·½Ê½1
 234   1              TMOD=0X21;                      //É timer 1 mode 2, timer 0 mode1
 235   1              PCON=0X80;                      //²¨ÌØÂÊ¼Ó±¶
 236   1              TH1=0XFA;                               //¼ÆÊýÆ÷³õÊ¼ÖµÉèÖÃ£¬×¢Òâ²¨ÌØÂÊÊÇ4800µÄ
 237   1              TL1=0XFA;
 238   1              ES=1;                                           //´ò¿ª½ÓÊÕÖÐ¶Ï
 239   1              EA=1;                                           //´ò¿ª×ÜÖÐ¶Ï
 240   1              TR1=1;                                  //´ò¿ª¼ÆÊýÆ÷
 241   1              
C51 COMPILER V9.01   SERIAL                                                                03/07/2019 18:07:34 PAGE 5   

 242   1              return -1;
 243   1      }
*** WARNING C280 IN LINE 227 OF SERIAL.C: 'baud': unreferenced local variable


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    542    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =    142      13
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
