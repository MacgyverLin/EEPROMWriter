C51 COMPILER V9.01   SERIAL                                                                03/01/2019 01:40:21 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE SERIAL
OBJECT MODULE PLACED IN serial.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE serial.c COMPACT ROM(COMPACT) OPTIMIZE(9,SIZE) REGFILE(.\template.ORC) BROW
                    -SE DEBUG OBJECTEXTEND

line level    source

   1          #include "serial.h"
   2          #include <reg52.h>
   3          #include <intrins.h>
   4          // #include <stdio.h>
   5          // #include <string.h>
   6          // #include <stdarg.h>
   7          // #include "vsscanf.h"
   8          
   9          #define TXBUF_SIZE 16
  10          #define RXBUF_SIZE 128
  11          
  12          unsigned char rxIdx;
  13          unsigned char rxBuffer[RXBUF_SIZE];
  14          unsigned char byteToRX;
  15          char rxDone;
  16          
  17          unsigned char txIdx;
  18          unsigned char txBuffer[TXBUF_SIZE];
  19          unsigned char byteToTX;
  20          char txDone;
  21          
  22          void serialISR(void) interrupt 4  
  23          {
  24   1              if(RI)
  25   1              {
  26   2                      if(!rxDone)
  27   2                      {
  28   3                              rxBuffer[rxIdx++] = SBUF;
  29   3                              if(rxIdx>=byteToRX)
  30   3                              {
  31   4                                      rxDone = -1;
  32   4                              }
  33   3                      }
  34   2                      
  35   2                      RI = 0;
  36   2              }
  37   1              if(TI)
  38   1              {
  39   2                      if(!txDone)
  40   2                      {
  41   3                              SBUF = txBuffer[txIdx++];
  42   3                              if(txIdx>=byteToTX)
  43   3                              {
  44   4                                      txDone = -1;
  45   4                              }
  46   3                      }
  47   2                      
  48   2                      TI = 0;
  49   2              }
  50   1      }
  51          
  52          void serialInitSendBuffer()
  53          {
  54   1              unsigned int i = 0;
C51 COMPILER V9.01   SERIAL                                                                03/01/2019 01:40:21 PAGE 2   

  55   1              
  56   1              while(TI);
  57   1      
  58   1              while(i<TXBUF_SIZE)
  59   1              {
  60   2                      txBuffer[i] = 0;
  61   2                      i++;
  62   2              }
  63   1              txIdx = 0;
  64   1              byteToTX = 0;
  65   1              txDone = -1;
  66   1      }
  67          
  68          void serialSendDataAsync(unsigned char* buffer, unsigned int size)
  69          {
  70   1              unsigned int i = 0;
  71   1              
  72   1              while(TI);
  73   1              
  74   1              while(i<size)
  75   1              {
  76   2                      txBuffer[i] = buffer[i];
  77   2                      i++;
  78   2              }
  79   1              txIdx = 0;
  80   1              byteToTX = size;
  81   1              txDone = 0;
  82   1      
  83   1              TI = 1;
  84   1      }
  85          
  86          char serialIsSendDataDone()
  87          {
  88   1              while(TI);
  89   1      
  90   1              return txDone;
  91   1      }
  92          
  93          void serialSendData(unsigned char* buffer, unsigned int size, int timeout)
  94          {
  95   1              int time = 0;
  96   1              
  97   1              serialSendDataAsync(buffer, size);
  98   1      
  99   1              while(!serialIsSendDataDone() && (timeout==-1 || time++<timeout));
 100   1      }
 101           
 102          void serialInitReceiveBuffer()
 103          {
 104   1              unsigned int i = 0;
 105   1              
 106   1              while(RI);
 107   1              
 108   1              while(i<RXBUF_SIZE)
 109   1              {
 110   2                      rxBuffer[i++] = 0;
 111   2              }
 112   1              rxIdx = 0;
 113   1              byteToRX = 0;
 114   1              rxDone = -1;
 115   1      }
 116          
C51 COMPILER V9.01   SERIAL                                                                03/01/2019 01:40:21 PAGE 3   

 117          void serialReceiveDataAsync(unsigned int size)
 118          {
 119   1              while(RI);
 120   1              
 121   1              rxIdx = 0;
 122   1              byteToRX = size;
 123   1              rxDone = 0;
 124   1      }
 125          
 126          char serialIsReceiveDataDone()
 127          {
 128   1              while(RI);
 129   1      
 130   1              return rxDone;
 131   1      }
 132          
 133          void serialReceiveData(unsigned int size, int timeout)
 134          {
 135   1              int time = 0;
 136   1              
 137   1              serialReceiveDataAsync(size);
 138   1      
 139   1              while(!serialIsReceiveDataDone() && (timeout==-1 || time++<timeout));
 140   1      }
 141          
 142          char* serialGetReceivedData(int offset)
 143          {
 144   1              return &rxBuffer[offset];
 145   1      }
 146          
 147          /*
 148          int serialPrintf(char* buffer, const char *fmt, ...)
 149          {
 150                  //char buffer[16];
 151          
 152                  va_list argptr;
 153                  int cnt;
 154                  va_start(argptr, fmt);
 155          
 156                  cnt = vsprintf(buffer, fmt, argptr);
 157          
 158                  va_end(argptr);
 159                  
 160                  serialSendData(buffer, strlen(buffer));
 161          
 162                  return cnt;
 163          }
 164          
 165          int serialScanf(char* buffer, const char *fmt, ...)
 166          {
 167                  va_list argptr;
 168                  int cnt;
 169          
 170                  //char buffer[16];
 171                  serialReceiveData(strlen(buffer));
 172          
 173                  va_start(argptr, fmt);
 174          
 175                  cnt = vsscanf(buffer, fmt, argptr);
 176          
 177                  va_end(argptr); 
 178          
C51 COMPILER V9.01   SERIAL                                                                03/01/2019 01:40:21 PAGE 4   

 179                  return cnt;
 180          }
 181          */
 182          
 183          int serialInitialize(int baud)
 184          {       
 185   1              serialInitSendBuffer();
 186   1              serialInitReceiveBuffer();
 187   1                      
 188   1              ///////////////////////////////
 189   1              SCON=0X50;                      //设置为工作方式1
 190   1              TMOD=0X20;                      //设置计数器工作方式2
 191   1              PCON=0X80;                      //波特率加倍
 192   1              TH1=0XFA;                               //计数器初始值设置，注意波特率是4800的
 193   1              TL1=0XFA;
 194   1              ES=1;                                           //打开接收中断
 195   1              EA=1;                                           //打开总中断
 196   1              TR1=1;                                  //打开计数器
 197   1              
 198   1              return -1;
 199   1      }
*** WARNING C280 IN LINE 183 OF SERIAL.C: 'baud': unreferenced local variable


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    436    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =    150      18
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
