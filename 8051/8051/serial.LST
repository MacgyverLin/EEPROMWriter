C51 COMPILER V9.01   SERIAL                                                                03/06/2019 16:42:12 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE SERIAL
OBJECT MODULE PLACED IN serial.OBJ
COMPILER INVOKED BY: E:\Keil\C51\BIN\C51.EXE serial.c COMPACT ROM(COMPACT) OPTIMIZE(9,SIZE) BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "serial.h"
   2          #include <reg52.h>
   3          #include <intrins.h>
   4          // #include <stdio.h>
   5          // #include <string.h>
   6          // #include <stdarg.h>
   7          // #include "vsscanf.h"
   8          
   9          #define BUF_SIZE 128
  10          unsigned char buffer[BUF_SIZE];
  11          
  12          unsigned char rxIdx;
  13          unsigned char byteToRX;
  14          char rxDone;
  15          
  16          unsigned char txIdx;
  17          unsigned char byteToTX;
  18          char txDone;
  19          
  20          void serialISR(void) interrupt 4  
  21          {
  22   1              if(RI)
  23   1              {
  24   2                      if(!rxDone)
  25   2                      {
  26   3                              buffer[rxIdx++] = SBUF;
  27   3                              if(rxIdx>=byteToRX)
  28   3                              {
  29   4                                      rxDone = -1;
  30   4                              }
  31   3                      }
  32   2                      
  33   2                      RI = 0;
  34   2              }
  35   1              if(TI)
  36   1              {
  37   2                      if(!txDone)
  38   2                      {
  39   3                              SBUF = buffer[txIdx++];
  40   3                              if(txIdx>=byteToTX)
  41   3                              {
  42   4                                      txDone = -1;
  43   4                              }
  44   3                      }
  45   2                      
  46   2                      TI = 0;
  47   2              }
  48   1      }
  49          
  50          void serialInitSendBuffer()
  51          {
  52   1              unsigned int i = 0;
  53   1              
  54   1              while(TI);
  55   1      
C51 COMPILER V9.01   SERIAL                                                                03/06/2019 16:42:12 PAGE 2   

  56   1              while(i<BUF_SIZE)
  57   1              {
  58   2                      buffer[i] = 0;
  59   2                      i++;
  60   2              }
  61   1              txIdx = 0;
  62   1              byteToTX = 0;
  63   1              txDone = -1;
  64   1      }
  65          
  66          void serialSendDataAsync(unsigned char* dat, unsigned int size)
  67          {
  68   1              unsigned int i = 0;
  69   1              
  70   1              while(!txDone || TI);
  71   1              
  72   1              if(size>=BUF_SIZE)
  73   1                      size=BUF_SIZE;
  74   1              while(i<size)
  75   1              {
  76   2                      buffer[i] = dat[i];
  77   2                      i++;
  78   2              }
  79   1              txIdx = 0;
  80   1              byteToTX = size;
  81   1              txDone = 0;
  82   1      
  83   1              TI = 1;
  84   1      }
  85          
  86          char serialIsSendDataDone()
  87          {
  88   1              while(TI);
  89   1      
  90   1              return txDone;
  91   1      }
  92          
  93          void serialSendData(unsigned char* dat, unsigned int size, int timeout)
  94          {
  95   1              int time = 0;
  96   1              
  97   1              serialSendDataAsync(dat, size);
  98   1      
  99   1              while(!serialIsSendDataDone() && (timeout==-1 || time++<timeout));
 100   1      }
 101           
 102          void serialInitReceiveBuffer()
 103          {
 104   1              unsigned int i = 0;
 105   1              
 106   1              while(RI);
 107   1              
 108   1              while(i<BUF_SIZE)
 109   1              {
 110   2                      buffer[i++] = 0;
 111   2              }
 112   1              rxIdx = 0;
 113   1              byteToRX = 0;
 114   1              rxDone = -1;
 115   1      }
 116          
 117          void serialReceiveDataAsync(unsigned int size)
C51 COMPILER V9.01   SERIAL                                                                03/06/2019 16:42:12 PAGE 3   

 118          {
 119   1              unsigned int i = 0;
 120   1              
 121   1              while(!rxDone || RI);
 122   1      
 123   1              if(size>=BUF_SIZE)
 124   1                      size=BUF_SIZE;  
 125   1              while(i<BUF_SIZE)
 126   1              {
 127   2                      buffer[i++] = 0;
 128   2              }       
 129   1              rxIdx = 0;
 130   1              byteToRX = size;
 131   1      
 132   1              rxDone = 0;
 133   1      }
 134          
 135          char serialIsReceiveDataDone()
 136          {
 137   1              while(RI);
 138   1      
 139   1              return rxDone;
 140   1      }
 141          
 142          char* serialReceiveData(unsigned int size, int timeout)
 143          {
 144   1              int time = 0;
 145   1              
 146   1              serialReceiveDataAsync(size);
 147   1      
 148   1              while(!serialIsReceiveDataDone() && (timeout==-1 || time++<timeout));
 149   1              
 150   1              return buffer;
 151   1      }
 152          
 153          /*
 154          int serialPrintf(char* buffer, const char *fmt, ...)
 155          {
 156                  //char buffer[16];
 157          
 158                  va_list argptr;
 159                  int cnt;
 160                  va_start(argptr, fmt);
 161          
 162                  cnt = vsprintf(buffer, fmt, argptr);
 163          
 164                  va_end(argptr);
 165                  
 166                  serialSendData(buffer, strlen(buffer));
 167          
 168                  return cnt;
 169          }
 170          
 171          int serialScanf(char* buffer, const char *fmt, ...)
 172          {
 173                  va_list argptr;
 174                  int cnt;
 175          
 176                  //char buffer[16];
 177                  serialReceiveData(strlen(buffer));
 178          
 179                  va_start(argptr, fmt);
C51 COMPILER V9.01   SERIAL                                                                03/06/2019 16:42:12 PAGE 4   

 180          
 181                  cnt = vsscanf(buffer, fmt, argptr);
 182          
 183                  va_end(argptr); 
 184          
 185                  return cnt;
 186          }
 187          */
 188          
 189          int serialInitialize(int baud)
 190          {       
 191   1              serialInitSendBuffer();
 192   1              serialInitReceiveBuffer();
 193   1                      
 194   1              ///////////////////////////////
 195   1              SCON=0X50;                      //设置为工作方式1
 196   1              TMOD=0X20;                      //设置计数器工作方式2
 197   1              PCON=0X80;                      //波特率加倍
 198   1              TH1=0XFA;                               //计数器初始值设置，注意波特率是4800的
 199   1              TL1=0XFA;
 200   1              ES=1;                                           //打开接收中断
 201   1              EA=1;                                           //打开总中断
 202   1              TR1=1;                                  //打开计数器
 203   1              
 204   1              return -1;
 205   1      }
*** WARNING C280 IN LINE 189 OF SERIAL.C: 'baud': unreferenced local variable


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    502    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =    134      18
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
